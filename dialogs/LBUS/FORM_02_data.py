import com.ihsan.foundation.appserver as appserver
import com.ihsan.util.modman as modman
import traceback

# application-level modules, loaded via modman
modman.loadStdModules(globals(), 
  [
    "scripts#form_loaditem"
  ]
)


def FormOnSetDataEx(uideflist, params):
  config = uideflist.config 
  def GetValue(code, period, branches, isrp):
    if code=="()":
      return None
    code = eval(code)
    wClause = '('
    for i in range(len(code)):
      if i>0: 
        wClause+= " or "
      wClause+= "account_code like '%s" % (code[i])
      wClause+= "%'"
    wClause+= ') and branch_code in (%s)' % branches
    if isrp==1:
      wClause+= " and currency_code = 'IDR'"
    else:
      wClause+= " and currency_code <> 'IDR'"
    s = '''
       select sum(balancecumulative) "value" from table(%s(to_date('%s', 'dd-mm-yyyy')))
       where %s
    ''' % (config.MapDBTableName('core.getdailybalanceat'), period, wClause)
    value = config.CreateSQL(s).RawResult.value
    return value
  if params.DatasetCount == 0 or params.GetDataset(0).Structure.StructureName != 'data':
    return
  
  form_loaditem.setData(uideflist, params)
  if uideflist.uipData.Dataset.RecordCount==0:
    coaMap = {
      "100" : '''()''',
      "101" : '''()''',
      "102" : '''('401040400001', '401040400011', '401040100001', '401040100002', '401040100003', '401040100011', 
                  '401040100012', '401040100013', '401030600014', '401090000001',)''',
      "103" : '''('401070000001', '401070000011',)''',
      "104" : '''('401040200001', '401040200011',)''',
      "105" : '''()''',
      "106" : '''('401060000001', '401060000011', '401090000004',)''',
      "107" : '''('401090000002', '401030600015', '401050100001', '401050100002', '401050100003', '401050100004', 
                  '401050100009', '401050100011', '401050100012', '401050100013', '401050100014', '401050100019',)''',
      "108" : '''('401050200001', '401050200002', '401050200003', '401050200004', '401050200009', '401050200011', 
                  '401050200012', '401050200013', '401050200014', '401050200019', '401030600016', '401090000003',)''',
      "109" : '''()''',
      "111" : '''('401030600019', '401040310011', '401040320011', '401050300001', '401050300011', '401030600001', 
                  '401030600002', '401030600003', '401030600007', '401030600008',)''',
      "112" : '''('401010100001', '401010100011',)''',
      "113" : '''('401010200001', '401010300039',)''',
      "114" : '''()''',
      "115" : '''('401020220002',)''',
      "116" : '''('401020230003', '401020230013',)''',
      "117" : '''('401030100001', '401030100011',)''',
      "118" : '''('401030200001', '401030200011', '401030300001', '401030300011', '401020300039', '401020110001', 
                  '401020120002', '401020210001',)''',
      "119" : '''('401030600010',)''',
      "120" : '''()''',
      "121" : '''()''',
      "122" : '''()''',
      "123" : '''()''',
      "124" : '''()''',
      "125" : '''()''',
      "126" : '''()''',
      "127" : '''()''',
      "129" : '''()''',
      "130" : '''()''',
      "131" : '''()''',
      "132" : '''()''',
      "133" : '''()''',
      "134" : '''()''',
      "135" : '''()''',
      "136" : '''()''',
      "137" : '''('404030000001', '404030000012',)''',
      "138" : '''('404040360001', '404040360002', '404040360003', '404040360004',)''',
      "139" : '''('404040380001',)''',
      "140" : '''('404040360005',)''',
      "141" : '''('404040330001', '404040330002', '404040330003', '404040330004',)''',
      "143" : '''()''',
      "144" : '''('404020200001', '404020200002', '404020200003', '404020200004',)''',
      "145" : '''('404050100001', '404050100002', '404050100003', '404050100004', '404050100005', '404050100006', 
                  '404050100007', '404050100008', '404050100009', '404050100010', '404050200001', '404050200002',)''',
      "146" : '''()''',
      "149" : '''('404070000001', '404070000002', '404070000003', '404070000004', '404070000005', '404070000006', 
                  '404070000007', '404070000008', '404070000009', '404070000010', '404070000011', '404070000012', 
                  '404070000013', '404070000014', '404070000015', '404070000016', '404070000017', '404070000018', 
                  '404070000019', '404070000039', '404040340001', '404040340002', '404040380002', '404040380003', 
                  '404040380004', '404040380005', '404040370001', '404040370002', '404040370003', '404040310001', 
                  '404040310002', '404040320001', '404040320002', '404040320003', '404040320004', '404040320005', 
                  '404040320006', '404040320039',)''',
      "150" : '''()''',
      "151" : '''('505230700047', '502010220001', '502010220002',)''',
      "152" : '''('505020200019', '502010320001', '502010320002', '505230700048', '505230700050',)''',
      "153" : '''('502010120001', '502010120002', '502010700001',)''',
      "154" : '''('505010100001',)''',
      "155" : '''('505010200039',)''',
      "156" : '''('502010210001', '505230700046',)''',
      "157" : '''('502010310001',)''',
      "158" : '''('502010410001',)''',
      "159" : '''('502010110001',)''',
      "160" : '''()''',
      "161" : '''()''',
      "163" : '''()''',
      "164" : '''()''',
      "165" : '''()''',
      "167" : '''()''',
      "169" : '''()''',
      "170" : '''()''',
      "171" : '''()''',
      "172" : '''()''',
      "180" : '''()''',
      "185" : '''()''',
      "186" : '''('505020100001', '505020100002',)''',
      "189" : '''('505020200001', '505020200002', '505020200011', '505020200012', '505230700049',)''',
      "190" : '''()''',
      "192" : '''()''',
      "200" : '''('505040200001', '505040200002',)''',
      "210" : '''()''',
      "272" : '''('505060200001',)''',
      "279" : '''('505060400001', '505060400002', '505060400003', '505060400004', '505060400039', '505060100001',)''',
      "301" : '''('505150300008', '505150300026', '505150300017', '505150300003', '505150200022',)''',
      "302" : '''('505150300004', '505150100001', '505150100002', '505150200001',)''',
      "309" : '''('505150300001', '505150300002', '505150300005', '505150300006', '505150300007', '505150300009', 
                  '505150300010', '505150300011', '505150300012', '505150300013', '505150300014', '505150300015',
                  '505150300016', '505150300018', '505150300019', '505150300020', '505150300021', '505150300022',
                  '505150300023', '505150300024', '505150300025',)''',
      "310" : '''('505160300001', '505160300002', '505160300003', '505160300004', '505160300005', '505160300006', 
                  '505160300007', '505160300008',)''',
      "320" : '''('505170000001',)''',
      "330" : '''('505180000001', '505180000002', '505180000003', '505180000004', '505180000007', '505180000008', 
                  '505180000009', '505180000010', '505180000011', '505180000012', '505180000013', '505180000014', 
                  '505180000039',)''',
      "340" : '''('505190100001', '505190200004', '505190200005', '505190200006', '505190200007', '505190200008', 
                  '505190200009', '505190200010', '505190200011', '505190200039', '505190200001', '505190200002',)''',
      "350" : '''('505200000001', '505200000002', '505200000003', '505200000039',)''',
      "360" : '''('505210000001', '505210000002', '505210000003', '505210000004', '505210000005', '505210000006', 
                  '505210000007', '505210000008', '505210000009', '505210000010', '505210000011', '505210000012', 
                  '505210000013', '505210000014', '505210000039', '505180000005', '505180000006', '505220200001', 
                  '505220200002', '505220200003', '505220200004', '505220200005', '505220200039', '505220200049',)''',
      "371" : '''('505090200001', '505090200002', '505090200003', '505090200004', '505090200005', '505090200006',)''',
      "372" : '''('505090500039',)''',
      "373" : '''('505090100001',)''',
      "374" : '''('505070300001',)''',
      "375" : '''('505070100001', '505070100011',)''',
      "376" : '''('505070510001', '505070510002', '505070510003', '505070510011', '505070510012', '505070510013', 
                  '505070520001', '505070520011',)''',
      "377" : '''()''',
      "380" : '''('505070540001', '505070540011',)''',
      "381" : '''('505070400001', '505070900007', '505070900008',)''',
      "382" : '''('505070610001', '505070610011',)''',
      "383" : '''('505070620001', '505070620011',)''',
      "385" : '''('505070630001', '505070630011',)''',
      "386" : '''('505070800001', '505070800011',)''',
      "387" : '''()''',
      "389" : '''('505070900001', '505070900002', '505070900003', '505070900004',)''',
      "390" : '''('505030211001',)''',
      "399" : '''('505090500001', '505150400001', '505150400002', '505150400003', '505150400004', '505150400005', 
                  '505150400006', '505150400007', '505150400008', '505150400009', '505150400010', '505150400011', 
                  '505150400012', '505150400013', '505150400014', '505150400015', '505150400016', '505150400017', 
                  '505150400018', '505150400019', '505150400020', '505150400021', '505150400022', '505150400039',
                  '505190100002', '505190200003', '505220100001', '505220100002', '505220100003', '505230100001',
                  '505230100002', '505230100003', '505230100004', '505230200001', '505230200002', '505230200003', 
                  '505230200004', '505230200005', '505230300001', '505230300002', '505230300003', '505230300004', 
                  '505230300005', '505230300006', '505230300007', '505230300008', '505230300009', '505230300010', 
                  '505230300011', '505230300012', '505230300013', '505230300014', '505230400001', '505230400002', 
                  '505230400003', '505230400004', '505230400005', '505230400006', '505230400039', '505230500001', 
                  '505230500002', '505230500003', '505230500004', '505230500005', '505230500006', '505230500007', 
                  '505230500008', '505230500009', '505230500010', '505230500011', '505230500012', '505230500013', 
                  '505230500014', '505230500015', '505230500016', '505230500039', '505230600001', '505230600002', 
                  '505230600003', '505230600004', '505230600005', '505230600006', '505230600007', '505230600039', 
                  '505230700001', '505230700002', '505230700003', '505230700004', '505230700005', '505230700006', 
                  '505230700007', '505230700008', '505230700009', '505230700010', '505230700011', '505230700012', 
                  '505230700013', '505230700014', '505230700015', '505230700016', '505230700017', '505230700018', 
                  '505230700019', '505230700020', '505230700021', '505230700022', '505230700023', '505230700024', 
                  '505230700025', '505230700026', '505230700027', '505230700028', '505230700029', '505230700030', 
                  '505230700031', '505230700032', '505230700033', '505230700034', '505230700035', '505230700036', 
                  '505230700037', '505230700038', '505230700039', '505230700040', '505230700041', '505230700042', 
                  '505230700043', '505230700044', '505230700099',)''',
      "400" : '''()''',
      "405" : '''()''',
      "410" : '''()''',
      "411" : '''('407010000001',)''',
      "412" : '''()''',
      "413" : '''('401080100001', '401080100002', '401080100003', '401080100004', '401080100005',)''',
      "414" : '''()''',
      "415" : '''('407020000001',)''',
      "419" : '''('407040000001', '407040000002', '407040000003', '407040000004', '407040000005', '407040000006', 
                  '407040000007', '407040000039', '407010000002', '407010000003',)''',
      "420" : '''()''',
      "421" : '''('508010000001',)''',
      "422" : '''()''',
      "423" : '''('505120000001',)''',
      "424" : '''('508030100001', '508030100002', '508030100039',)''',
      "425" : '''('508020000001',)''',
      "426" : '''('502010610001', '502010610002', '502010610003', '502010610004', '502010610005',)''',
      "427" : '''()''',
      "429" : '''('508030200001', '508030200002', '508030200003', '508030200004', '508030200005', '508030200006', 
                  '508030200007', '508030200039',)''',
      "430" : '''()''',
      "435" : '''()''',
      "440" : '''()''',
      "445" : '''()''',
      "447" : '''('513020100001',)''',
      "448" : '''('513020200001',)''',
      "451" : '''()''',
      "455" : '''()''',
      "461" : '''()''',
      "465" : '''()''',
      "470" : '''()''',
      "475" : '''()''',
      "480" : '''('513010000001',)''',
      "490" : '''()''',
      "500" : '''()'''
    }
    coaMapx = {
      "100" : '''()''',
      "101" : '''()''',
      "102" : '''('401040400001', '401040400011', '401040100001', '401040100002', '401040100003', '401040100011', 
                  '401040100012', '401040100013', '401030600014', '401090000001',)''',
      "103" : '''('401070000001', '401070000011',)''',
      "104" : '''('401040200001', '401040200011',)''',
      "105" : '''()''',
      "106" : '''('401060000001', '401060000011', '401090000004',)''',
      "107" : '''('401090000002', '401030600015', '401050100001', '401050100002', '401050100003', '401050100004', 
                  '401050100009', '401050100011', '401050100012', '401050100013', '401050100014', '401050100019',)''',
      "108" : '''('401050200001', '401050200002', '401050200003', '401050200004', '401050200009', '401050200011', 
                  '401050200012', '401050200013', '401050200014', '401050200019', '401030600016', '401090000003',)''',
      "109" : '''()''',
      "111" : '''('401030600019', '401040310011', '401040320011', '401050300001', '401050300011', '401030600001', 
                  '401030600002', '401030600003', '401030600007', '401030600008',)''',
      "112" : '''('401010100001', '401010100011',)''',
      "113" : '''('401010200001', '401010300039',)''',
      "114" : '''()''',
      "115" : '''('401020220002',)''',
      "116" : '''('401020230003', '401020230013',)''',
      "117" : '''('401030100001', '401030100011',)''',
      "118" : '''('401030200001', '401030200011', '401030300001', '401030300011', '401020300039', '401020110001', 
                  '401020120002', '401020210001',)''',
      "119" : '''('401030600010',)''',
      "120" : '''()''',
      "121" : '''()''',
      "122" : '''()''',
      "123" : '''()''',
      "124" : '''()''',
      "125" : '''()''',
      "126" : '''()''',
      "127" : '''()''',
      "129" : '''()''',
      "130" : '''()''',
      "131" : '''()''',
      "132" : '''()''',
      "133" : '''()''',
      "134" : '''()''',
      "135" : '''()''',
      "136" : '''()''',
      "137" : '''('404030000001', '404030000012',)''',
      "138" : '''('404040360001', '404040360002', '404040360003', '404040360004',)''',
      "139" : '''('404040380001',)''',
      "140" : '''('404040360005',)''',
      "141" : '''('404040330001', '404040330002', '404040330003', '404040330004',)''',
      "143" : '''()''',
      "144" : '''('404020200001', '404020200002', '404020200003', '404020200004',)''',
      "145" : '''('404050100001', '404050100002', '404050100003', '404050100004', '404050100005', '404050100006', 
                  '404050100007', '404050100008', '404050100009', '404050100010', '404050200001', '404050200002',)''',
      "146" : '''()''',
      "149" : '''('404040310001', '404040310002', '404040320001', '404040320002', '404040320003', '404040320004', 
                  '404040320005', '404040320006', '404040320039', '404040340001', '404040340002', '404040370001', 
                  '404040370002', '404040370003', '404040380002', '404040380003', '404040380004', '404040380005', 
                  '404070000001', '404070000002', '404070000003', '404070000004', '404070000005', '404070000006', 
                  '404070000007', '404070000008', '404070000009', '404070000010', '404070000011', '404070000012', 
                  '404070000013', '404070000014', '404070000015', '404070000016', '404070000017', '404070000018', 
                  '404070000019', '404070000039',)''',
      "150" : '''()''',
      "151" : '''('505230700047', '502010220001', '502010220002',)''',
      "152" : '''('505020200019', '502010320001', '502010320002', '505230700048', '505230700050',)''',
      "153" : '''('502010120001', '502010120002', '502010700001',)''',
      "154" : '''('505010100001',)''',
      "155" : '''('505010200039',)''',
      "156" : '''('502010210001', '505230700046',)''',
      "157" : '''('502010310001',)''',
      "158" : '''('502010410001',)''',
      "159" : '''('502010110001',)''',
      "160" : '''()''',
      "161" : '''()''',
      "163" : '''()''',
      "164" : '''()''',
      "165" : '''()''',
      "167" : '''()''',
      "169" : '''()''',
      "170" : '''()''',
      "171" : '''()''',
      "172" : '''()''',
      "180" : '''()''',
      "185" : '''()''',
      "186" : '''('505020100001', '505020100002',)''',
      "189" : '''('505020200001', '505020200002', '505020200011', '505020200012', '505230700049',)''',
      "190" : '''()''',
      "192" : '''()''',
      "200" : '''('505040200001', '505040200002',)''',
      "210" : '''()''',
      "272" : '''('505060200001',)''',
      "279" : '''('505060400001', '505060400002', '505060400003', '505060400004', '505060400039', '505060100001',)''',
      "301" : '''('505150300008', '505150300026', '505150300017', '505150300003', '505150200022',)''',
      "302" : '''('505150300004', '505150100001', '505150100002', '505150200001',)''',
      "309" : '''('505150300001', '505150300002', '505150300005', '505150300006', '505150300007', '505150300009', 
                  '505150300010', '505150300011', '505150300012', '505150300013', '505150300014', '505150300015', 
                  '505150300016', '505150300018', '505150300019', '505150300020', '505150300021', '505150300022', 
                  '505150300023', '505150300024', '505150300025',)''',
      "310" : '''('505160300001', '505160300002', '505160300003', '505160300004', '505160300005', '505160300006', 
                  '505160300007', '505160300008',)''',
      "320" : '''('505170000001',)''',
      "330" : '''('505180000001', '505180000002', '505180000003', '505180000004', '505180000007', '505180000008', 
                  '505180000009', '505180000010', '505180000011', '505180000012', '505180000013', '505180000014', 
                  '505180000039',)''',
      "340" : '''('505190100001', '505190200004', '505190200005', '505190200006', '505190200007', '505190200008', 
                  '505190200009', '505190200010', '505190200011', '505190200039', '505190200001', '505190200002',)''',
      "350" : '''('505200000001', '505200000002', '505200000003', '505200000039',)''',
      "360" : '''('505210000001', '505210000002', '505210000003', '505210000004', '505210000005', '505210000006', 
                  '505210000007', '505210000008', '505210000009', '505210000010', '505210000011', '505210000012', 
                  '505210000013', '505210000014', '505210000039', '505180000005', '505180000006', '505220200001', 
                  '505220200002', '505220200003', '505220200004', '505220200005', '505220200039', '505220200049',)''',
      "371" : '''('505090200001', '505090200002', '505090200003', '505090200004', '505090200005', '505090200006',)''',
      "372" : '''('505090500039',)''',
      "373" : '''('505090100001',)''',
      "374" : '''('505070300001',)''',
      "375" : '''('505070100001', '505070100011',)''',
      "376" : '''('505070510001', '505070510002', '505070510003', '505070510011', '505070510012', '505070510013', 
                  '505070520001', '505070520011',)''',
      "377" : '''()''',
      "380" : '''('505070540001', '505070540011',)''',
      "381" : '''('505070400001', '505070900007', '505070900008',)''',
      "382" : '''('505070610001', '505070610011',)''',
      "383" : '''('505070620001', '505070620011',)''',
      "385" : '''('505070630001', '505070630011',)''',
      "386" : '''('505070800001', '505070800011',)''',
      "387" : '''()''',
      "389" : '''('505070900001', '505070900002', '505070900003', '505070900004',)''',
      "390" : '''('505030211001',)''',
      "399" : '''('505090500001', '505150400001', '505150400002', '505150400003', '505150400004', '505150400005', '505150400006', 
                  '505150400007', '505150400008', '505150400009', '505150400010', '505150400011', '505150400012', '505150400013', 
                  '505150400014', '505150400015', '505150400016', '505150400017', '505150400018', '505150400019', '505150400020', 
                  '505150400021', '505150400022', '505150400039', '505190100002', '505190200003', '505220100001', '505220100002', 
                  '505220100003', '505230100001', '505230100002', '505230100003', '505230100004', '505230200001', '505230200002', 
                  '505230200003', '505230200004', '505230200005', '505230300001', '505230300002', '505230300003', '505230300004', 
                  '505230300005', '505230300006', '505230300007', '505230300008', '505230300009', '505230300010', '505230300011', 
                  '505230300012', '505230300013', '505230300014', '505230400001', '505230400002', '505230400003', '505230400004', 
                  '505230400005', '505230400006', '505230400039', '505230500001', '505230500002', '505230500003', '505230500004', 
                  '505230500005', '505230500006', '505230500007', '505230500008', '505230500009', '505230500010', '505230500011', 
                  '505230500012', '505230500013', '505230500014', '505230500015', '505230500016', '505230500039', '505230600001', 
                  '505230600002', '505230600003', '505230600004', '505230600005', '505230600006', '505230600007', '505230600039', 
                  '505230700001', '505230700002', '505230700003', '505230700004', '505230700005', '505230700006', '505230700007', 
                  '505230700008', '505230700009', '505230700010', '505230700011', '505230700012', '505230700013', '505230700014', 
                  '505230700015', '505230700016', '505230700017', '505230700018', '505230700019', '505230700020', '505230700021', 
                  '505230700022', '505230700023', '505230700024', '505230700025', '505230700026', '505230700027', '505230700028', 
                  '505230700029', '505230700030', '505230700031', '505230700032', '505230700033', '505230700034', '505230700035', 
                  '505230700036', '505230700037', '505230700038', '505230700039', '505230700040', '505230700041', '505230700042', 
                  '505230700043', '505230700044', '505230700099', )''',
      "400" : '''()''',
      "405" : '''()''',
      "410" : '''()''',
      "411" : '''('407010000001',)''',
      "412" : '''()''',
      "413" : '''('401080100001', '401080100002', '401080100003', '401080100004', '401080100005',)''',
      "414" : '''()''',
      "415" : '''('407020000001',)''',
      "419" : '''('407040000001', '407040000002', '407040000003', '407040000004', '407040000005', '407040000006', 
                  '407040000007', '407040000039', '407010000002', '407010000003',)''',
      "420" : '''()''',
      "421" : '''('508010000001',)''',
      "422" : '''()''',
      "423" : '''('505120000001',)''',
      "424" : '''('508030100001', '508030100002', '508030100039',)''',
      "425" : '''('508020000001',)''',
      "426" : '''()''',
      "427" : '''('502010610001', '502010610002', '502010610003', '502010610004', '502010610005',)''',
      "429" : '''('508030200001', '508030200002', '508030200003', '508030200004', '508030200005', '508030200006', 
                  '508030200007', '508030200039',)''',
      "430" : '''()''',
      "435" : '''()''',
      "440" : '''()''',
      "445" : '''()''',
      "447" : '''('513020100001',)''',
      "448" : '''('513020200001',)''',
      "451" : '''()''',
      "455" : '''()''',
      "461" : '''()''',
      "465" : '''()''',
      "470" : '''()''',
      "475" : '''()''',
      "480" : '''('513010000001',)''',
      "490" : '''()''',
      "500" : '''()'''
    }
    mlu = config.ModLibUtils
    s = '''
      select kode_cabang from branchmember where branch_id=%s
    ''' % (str(params.FirstRecord.branch_id))
    branchmembers = config.CreateSQL(s).RawResult
    listcabang = ''
    while not branchmembers.Eof:
      if listcabang != '':
        listcabang+=', '
      listcabang+=mlu.QuotedStr(branchmembers.kode_cabang)
      branchmembers.Next()
    pid = params.FirstRecord.period_id
    pCode = config.CreateSQL("select period_code from period where period_id=%s" % pid).RawResult.period_code
    tgl = 1
    bln = int(pCode[:2])
    thn = int(pCode[2:6])
    repdate = mlu.EncodeDate(thn, bln+1, tgl)
    repdate = repdate-1
    (thn, bln, tgl) = mlu.DecodeDate(repdate)  
    period = "%s-%s-%s" % (str(tgl),str(bln),str(thn))
    ds = uideflist.uipData.Dataset
    s = "select * from %s a, %s b where a.reftype_id=b.reftype_id and b.reference_name='R_POS_LR_LBU' order by a.refdata_id" % (
                config.MapDBTableName('enterprise.referencedata'),    
                config.MapDBTableName('enterprise.referencetype')
        )
    res = config.CreateSQL(s).RawResult
    tosum = ['100','101','136','150','170','180','410','420',
             '171','172',
             '400','405','430','435','440','445','490','500'
             ]    
    sumres = {}
    for kd in tosum:
      sumres[kd] = [0,0,0]
    while not res.Eof:
      if res.reference_code in coaMap.keys(): 
        value = GetValue(coaMap[res.reference_code], period, listcabang, 1)
      else:
        value = None
      if value not in (None,'',0):
        #if value<0: value=value*-1
        rp = int(value/100000)
        if int(str(rp)[-1])>4:
          if rp<0:
            rp = (rp/10)
          else:
            rp = (rp/10)+1
        else:
          if rp<0:
            rp = (rp/10)+1
          else:
            rp = rp/10
      else:
        rp = 0
      if res.reference_code in coaMap.keys(): 
        value = GetValue(coaMap[res.reference_code], period, listcabang, 0)
      else:
        value = None
      if value not in (None,'',0):
        #if value<0: value=value*-1
        valas = int(value/1000000)
        if int(str(valas)[-1])>4:
          if valas<0:
            valas = valas/10
          else:
            valas = (valas/10)+1
        else:
          if valas<0:
            valas = (valas/10)+1
          else:
            valas = valas/10
      else:
        valas = 0
      rec = ds.AddRecord()
      rec.SetFieldByName('LPOS.reference_desc', res.reference_desc)    
      rec.SetFieldByName('LPOS.reference_code', res.reference_code)    
      rec.SetFieldByName('LPOS.refdata_id', res.refdata_id)
      if res.reference_code not in (None,'', ' '):
        kode = int(res.reference_code)
      else:
        kode = 0
      total = rp+valas
      if kode in range(102,150):
        sumres['100'][0]+=rp
        sumres['100'][1]+=valas
        sumres['100'][2]+=total
      if kode in range(102,136):
        sumres['101'][0]+=rp
        sumres['101'][1]+=valas
        sumres['101'][2]+=total
      if kode in range(137,150):
        sumres['136'][0]+=rp
        sumres['136'][1]+=valas
        sumres['136'][2]+=total
      if kode in range(151,170):
        sumres['150'][0]+=rp
        sumres['150'][1]+=valas
        sumres['150'][2]+=total
      if kode in range(185,400):
        sumres['180'][0]+=rp
        sumres['180'][1]+=valas
        sumres['180'][2]+=total
      if kode in range(411,420):
        sumres['410'][0]+=rp
        sumres['410'][1]+=valas
        sumres['410'][2]+=total
      if kode in range(421,430):
        sumres['420'][0]+=rp
        sumres['420'][1]+=valas
        sumres['420'][2]+=total
      if rp<0: rp=rp*-1
      if valas<0: valas=valas*-1
      if total<0: total=total*-1
      rec.SetFieldByName('Value1', str(rp))    
      rec.SetFieldByName('Value2', str(valas))    
      rec.SetFieldByName('Total', str(total))    
      res.Next()
    #a = ds.GetRecord(2)
    #raise Exception, a.GetFieldByName('LPOS.reference_desc')
    rownum = {}
    for i in range(ds.RecordCount):
      cek = ds.GetRecord(i)
      kode = cek.GetFieldByName('LPOS.reference_code')
      if kode.strip(' ') not in (None,'', 0):
        rownum[kode] = i
        if kode not in tosum:
          sumres[kode] = [0,0,0]
          sumres[kode][0] = int(cek.GetFieldByName('Value1'))
          sumres[kode][1] = int(cek.GetFieldByName('Value2'))
          sumres[kode][2] = int(cek.GetFieldByName('Total'))
    rp = sumres['100'][0]-sumres['150'][0]
    if rp>0:
      sumres['171'][0] = rp
    if rp<0:
      sumres['172'][0] = rp*-1 
    valas = sumres['100'][1]-sumres['150'][1]
    if valas>0:
      sumres['171'][1] = valas
    if valas<0:
      sumres['172'][1] = valas*-1
    sumres['171'][2] = sumres['171'][0]+sumres['171'][1] 
    sumres['172'][2] = sumres['172'][0]+sumres['172'][1] 
    if i in range(3):
      sumres['170'][i] = sumres['171'][i]+sumres['172'][i]
    rp = sumres['170'][0]-sumres['180'][0]
    if rp>0:
      sumres['400'][0] = rp
    if rp<0:
      sumres['405'][0] = rp*-1 
    valas = sumres['170'][1]-sumres['180'][1]
    if valas>0:
      sumres['400'][1] = valas
    if valas<0:
      sumres['405'][1] = valas*-1
    sumres['400'][2] = sumres['400'][0]+sumres['400'][1] 
    sumres['405'][2] = sumres['405'][0]+sumres['405'][1]
    rp = sumres['410'][0]-sumres['420'][0]
    if rp>0:
      sumres['430'][0] = rp
    if rp<0:
      sumres['435'][0] = rp*-1 
    valas = sumres['410'][1]-sumres['420'][1]
    if valas>0:
      sumres['430'][1] = valas
    if valas<0:
      sumres['435'][1] = valas*-1
    sumres['430'][2] = sumres['430'][0]+sumres['430'][1] 
    sumres['435'][2] = sumres['435'][0]+sumres['435'][1] 
    rp = sumres['400'][0]-sumres['405'][0]+sumres['430'][0]-sumres['435'][0]
    if rp>0:
      sumres['440'][0] = rp
    if rp<0:
      sumres['445'][0] = rp*-1 
    valas = sumres['400'][1]-sumres['405'][1]+sumres['430'][1]-sumres['435'][1]
    if valas>0:
      sumres['440'][1] = valas
    if valas<0:
      sumres['445'][1] = valas*-1
    sumres['430'][2] = sumres['440'][0]+sumres['440'][1] 
    sumres['445'][2] = sumres['445'][0]+sumres['445'][1] 
    rp = sumres['440'][0]-sumres['445'][0]+sumres['447'][0]-sumres['448'][0]+sumres['451'][0]+sumres['455'][0]-sumres['461'][0]-sumres['465'][0]+sumres['470'][0]-sumres['475'][0]-sumres['480'][0]
    if rp>0:
      sumres['490'][0] = rp
    if rp<0:
      sumres['500'][0] = rp*-1 
    valas = sumres['440'][1]-sumres['445'][1]+sumres['447'][1]-sumres['448'][1]+sumres['451'][1]+sumres['455'][1]-sumres['461'][1]-sumres['465'][1]+sumres['470'][1]-sumres['475'][1]-sumres['480'][1]
    if valas>0:
      sumres['490'][1] = valas
    if valas<0:
      sumres['500'][1] = valas*-1
    sumres['490'][2] = sumres['490'][0]+sumres['490'][1] 
    sumres['500'][2] = sumres['500'][0]+sumres['500'][1]
    for kd in tosum:
      upd = ds.GetRecord(rownum[kd])
      upd.SetFieldByName('Value1', str(sumres[kd][0]))
      upd.SetFieldByName('Value2', str(sumres[kd][1]))
      upd.SetFieldByName('Total', str(sumres[kd][2]))
    #--
